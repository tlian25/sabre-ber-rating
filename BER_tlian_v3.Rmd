---
title: "BER_tlian_v3"
author: "TXL"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
library(data.table)
library(tidyverse)
library(gridExtra)
library(multiwayvcov)


# Source tool functions file
source("BER_tool_functions.R")

# Make sure folder is correct and exists
possible_folders = c("/Users/txl/TXL_R/Final Data/",
                     "~/Final Data/",
                     "C:/Users/TXL/Documents/SportsAnalyticsData/Final Data/")
folder_name = ""
for (f in possible_folders) {
  if (dir.exists(f)) {folder_name = f}
}
print(paste0("Folder name: ", folder_name))


# Create export_folder if it does not already exist
export_folder = "./BER_Export_Files/"
if (!file.exists(export_folder)){
  print(paste0("Creating export folder: ", export_folder))
  dir.create(export_folder)
}

```



### NOTES/TO-DO:
* Cluster on half-innings
* Compare our measure vs other measures in predicting salary/persistence, etc
* Incremental improve over RE24?
* Controlled for factors (RE24 does not)
* Standardization
* (Park_factor-100) * 24states
* FIP * 24states

# BER Version 3

We use the following methodology to calculate BERs for a given year.
1. For year $Y$, aggregate all data in years $[Y-2, Y+2]$ to use in regression model. Calculate across time.
2. Create a BER table for players for each season
Note: We have data for years 1975-2018. Easy to start at year 1977, but need to decide what to do with year 2018.

# Aggregate data
We write a for-loop covering only one year as it will be easily translatable across time. 
```{r, eval = T, message = F}
# Lists to store values and player_tables
vl_list = list()
pt_list = list()
coef_list = list()
covar_list = list()

# Year range
years = 1977:2016
for (y in years) {
  print(paste("Aggregating data for year:", as.character(y)))
  datalist = list()
  for (i in (y-2):(y+2)) {
    if (i == y) {
      current_year_dt = import_season_data(i)
      datalist[[i]] = current_year_dt
    }
    else {
      datalist[[i]] = import_season_data(i)
    }

  }
  dt = do.call(rbind, datalist) # Aggregate data.table
  
  # Now we run the regression model with this data.table
  # m$reg contains the full linear model
  # m$reg_vl contains the list of values for each state
  m = calculate_BER_value_function_league_pf_fip(dt)
  
  # Calculate BER for each AB with current_year_dt and values
  BER_dt = calculate_BER_league_pf_fip(current_year_dt, m$vl)
  
  # Aggregate BER for players
  player_table = create_player_table(BER_dt)
  
  # Add values to list
  player_table$season = y
  pt_list[[y]] = player_table
  
  # Add values to value_list
  vl_list[[y]] = m$vl %>% data.table(state = names(.), value = ., season = y)
  
  # Add coefficients and clustered se to list
  m$coef.se$season = y
  coef_list[[y]] = m$coef.se 
  
  # Add clustered covariance matrix to list
  covar_list[[y]] = data.table(m$covar.mat, season = y)

  # Export CSVs
  print("Exporting BER_dt...")
  fwrite(BER_dt, paste0(export_folder, "BER_dt_", as.character(y), ".csv"))
  print(paste0("Successfully exported all tables for year: ", as.character(y)))
   
}

# Export value functions across all seasons
vl.all = do.call(rbind, vl_list)
fwrite(vl.all, paste0(export_folder, "values_league_pf_fip.csv"))

# Export player BERs across all seasons
pt.all = do.call(rbind, pt_list)
fwrite(pt.all, paste0(export_folder, "player_table_league_pf_fip.csv"))

# Export raw coefficients and clustered SEs
coef.all = do.call(rbind, coef_list)
fwrite(coef.all, paste0(export_folder, "raw_coef_se_league_pf_fip.csv"))

# Export clustered covariance matrix
covar.all = do.call(rbind, covar_list)
fwrite(covar.all, paste0(export_folder, "covar_league_pf_fip.csv"))


```

# Compare Value Functions Across Time
```{r}
# Load from export folder
vl = fread(paste0(export_folder, "values_league_pf_fip.csv"))
vl$league = if_else(grepl("*NL", vl$state), "NL", "AL")
vl$state_raw = str_replace(vl$state, ".L$", "")

# States across years
vl %>% 
  ggplot(aes(x = season, y = value, group = state)) + 
  geom_line(aes(color = state)) + 
  ggtitle("Value of States across years")

# NL States across years
vl[grepl("*NL", state)] %>% 
  ggplot(aes(x = season, y = value, group = state)) + 
  geom_line(aes(color = state)) + 
  ggtitle("Value of NL States across years")

# AL States across years
vl[grepl("*AL", state)] %>%
  ggplot(aes(x = season, y = value, group = state)) + 
  geom_line(aes(color = state)) + 
  ggtitle("Value of AL States across years")

# Plot range of states 

vl %>%
  ggplot(aes(x = state, y = value)) + geom_boxplot(aes(color = league)) + 
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("League Model Coefficients (all factors)")





```



# Highest BER players for each season
```{r}
pt.all = fread(paste0(export_folder, "player_table_league_pf_fip.csv"))
years = 2015:2016
for (y in years) {
  # Subset season, PA > 100
  season = pt.all[Season == y][PA_count > 100][order(BER, decreasing = T)]
  print(paste0("Highest BER (PA > 100) in season ", as.character(y)))
  print(head(season, 10))
}

```

# Player Lifetime BERs
```{r}
# Load Data
pt.all = fread(paste0(export_folder, "player_table_league_pf_fip.csv"))
# Create a weighted BER total for each season
pt.all$weighted_sum_BER = pt.all$PA_count * pt.all$BER
# Group by player
pt.grouped = pt.all %>% group_by(res_batter, player_name) %>%
  summarize(PA_count = sum(PA_count), BER = sum(weighted_sum_BER)/sum(PA_count), 
            RE24 = sum(RE24))

# Lifetime Highest BERs
print("Lifetime Higest BERs (PA > 100)")
print(head(pt.grouped %>% 
             filter(PA_count > 500) %>%
             arrange(desc(BER)), 50))



```



